<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S & Q - App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        
        :root { --nude: #C4A484; --bg: #F9F7F5; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: #4A443F; padding-bottom: 120px; -webkit-tap-highlight-color: transparent; }
        
        .page { display: none; padding: 20px; animation: fade 0.3s; }
        .page.active { display: block; }
        @keyframes fade { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* CARTE STYLE GIRL MOOD */
        .card { 
            background: white; 
            border-radius: 24px; 
            padding: 20px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 15px; 
        }
        
        /* NAVIGATION */
        .nav-bar { 
            position: fixed; bottom: 20px; left: 15px; right: 15px; 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            height: 70px; border-radius: 35px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); z-index: 999; 
            overflow-x: auto;
        }
        .nav-btn { color: #D1C7BD; font-size: 20px; min-width: 45px; text-align: center; }
        .nav-btn.active { color: var(--nude); transform: scale(1.2); }

        /* MOOD */
        .mood-btn { font-size: 30px; opacity: 0.3; filter: grayscale(1); background: none; border: none; }
        .mood-btn.active { opacity: 1; filter: grayscale(0); transform: scale(1.2); }

        /* INPUTS */
        .input-box { width: 100%; background: #F3F4F6; border-radius: 12px; padding: 12px; margin-bottom: 8px; font-size: 14px; outline: none; }
    </style>
</head>
<body>

    <div class="px-6 pt-10 pb-4 flex justify-between items-end">
        <h1 class="text-2xl font-bold text-[#4A443F]">Samia & Quincy</h1>
        <button onclick="logout()" class="text-xs text-gray-400 bg-white px-3 py-1 rounded-full border">Compte: <span id="u-name">...</span></button>
    </div>

    <div id="home" class="page active">
        <div class="card text-center">
            <p class="text-xs font-bold text-gray-400 mb-4 uppercase">Humeur du jour</p>
            <div class="flex justify-between px-2 mb-4">
                <button onclick="setMood('üòç', this)" class="mood-btn">üòç</button>
                <button onclick="setMood('üòä', this)" class="mood-btn">üòä</button>
                <button onclick="setMood('ü§≤', this)" class="mood-btn">ü§≤</button>
                <button onclick="setMood('üòî', this)" class="mood-btn">üòî</button>
                <button onclick="setMood('üò¥', this)" class="mood-btn">üò¥</button>
            </div>
            <div class="flex justify-around border-t pt-4">
                <div><span class="text-[10px] font-bold block text-gray-400">SAMIA</span><span id="m-samia" class="text-2xl">...</span></div>
                <div><span class="text-[10px] font-bold block text-gray-400">QUINCY</span><span id="m-quincy" class="text-2xl">...</span></div>
            </div>
        </div>

        <div class="card">
            <h3 class="font-bold mb-3">Calendrier</h3>
            <div id="cal-grid" class="grid grid-cols-7 gap-1 text-center text-xs mb-2"></div>
            <div id="evt-box" class="hidden bg-orange-50 p-3 rounded-xl text-xs mt-2 border border-orange-100">
                <p id="sel-date" class="font-bold text-[#C4A484] mb-2">...</p>
                <div id="evt-list" class="space-y-1 mb-2"></div>
                <div class="flex gap-2">
                    <input type="text" id="new-evt" placeholder="Nouveau RDV..." class="input-box bg-white mb-0">
                    <button onclick="addEvt()" class="bg-[#C4A484] text-white px-3 rounded-lg">+</button>
                </div>
            </div>
        </div>
    </div>

    <div id="places" class="page">
        <h2 class="text-lg font-bold mb-4 ml-2">Adresses üçî</h2>
        <div class="card bg-gray-50">
            <input type="text" id="pl-name" placeholder="Nom du lieu" class="input-box bg-white">
            <div class="flex gap-2">
                <select id="pl-cat" class="input-box bg-white w-1/3"><option value="Resto">Resto</option><option value="FastFood">Fast</option><option value="Activite">Fun</option></select>
                <input type="text" id="pl-loc" placeholder="Ville" class="input-box bg-white">
            </div>
            <button onclick="addPlace()" class="w-full bg-gray-800 text-white py-3 rounded-xl font-bold text-xs">Ajouter</button>
        </div>
        <div id="pl-list" class="space-y-3"></div>
    </div>

    <div id="chat" class="page">
        <h2 class="text-lg font-bold mb-4 text-center">Discussion üí¨</h2>
        <div id="chat-box" class="h-[60vh] overflow-y-auto pb-4 space-y-3 px-1"></div>
        
        <div class="fixed bottom-[100px] left-4 right-4 z-50">
            <div id="poll-modal" class="hidden bg-white p-4 rounded-3xl shadow-2xl border mb-3">
                <p class="text-xs font-bold mb-2 text-center">SONDAGE PHOTO</p>
                <input type="text" id="pq" placeholder="Question ?" class="input-box">
                <div class="flex gap-2 mb-2">
                    <label class="bg-gray-100 flex-1 h-20 rounded-xl flex items-center justify-center cursor-pointer border border-dashed border-gray-400 text-[10px]">
                        üì∏ Photo 1 <input type="file" class="hidden" onchange="compress(this, 'p1')">
                    </label>
                    <label class="bg-gray-100 flex-1 h-20 rounded-xl flex items-center justify-center cursor-pointer border border-dashed border-gray-400 text-[10px]">
                        üì∏ Photo 2 <input type="file" class="hidden" onchange="compress(this, 'p2')">
                    </label>
                </div>
                <div class="flex gap-2 mb-2 text-[10px] text-green-500 font-bold text-center">
                    <span id="ok-p1" class="flex-1 hidden">OK !</span>
                    <span id="ok-p2" class="flex-1 hidden">OK !</span>
                </div>
                <button onclick="sendPoll()" class="w-full bg-[#C4A484] text-white py-3 rounded-xl font-bold text-xs">Envoyer</button>
            </div>

            <div class="flex gap-2 items-center bg-white p-2 rounded-full shadow-xl border">
                <button onclick="document.getElementById('poll-modal').classList.toggle('hidden')" class="w-10 h-10 rounded-full bg-gray-100 text-[#C4A484]"><i class="fa-solid fa-camera"></i></button>
                <input type="text" id="msg" placeholder="Message..." class="flex-1 outline-none text-sm px-2">
                <button onclick="sendMsg()" class="w-10 h-10 rounded-full bg-[#C4A484] text-white"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
    </div>

    <div id="budget" class="page">
        <h2 class="text-lg font-bold mb-4 ml-2">Finances üí∏</h2>
        <div class="card bg-[#4A443F] text-white">
            <div class="flex justify-between items-center mb-2">
                <div><p class="text-[10px] opacity-60">√âconomies</p><h2 class="text-3xl font-bold" id="tot-save">0 ‚Ç¨</h2></div>
                <button onclick="editSave()" class="bg-white/10 px-4 py-2 rounded-xl text-xs font-bold">+ / -</button>
            </div>
            <div id="hist-save" class="text-[10px] opacity-70 border-t border-white/10 pt-2 space-y-1 max-h-20 overflow-y-auto"></div>
        </div>
        
        <div class="card">
            <div class="flex justify-between font-bold text-sm mb-2"><span>üíç Mariage</span> <span id="t-wed" class="text-[#C4A484]">0‚Ç¨</span></div>
            <div id="l-wed" class="space-y-2 text-xs"></div>
            <button onclick="addBud('wed')" class="w-full text-[10px] border border-dashed rounded py-2 mt-3">+ D√©pense</button>
        </div>
        <div class="card">
            <div class="flex justify-between font-bold text-sm mb-2"><span>üè† Appart</span> <span id="t-apt" class="text-blue-500">0‚Ç¨</span></div>
            <div id="l-apt" class="space-y-2 text-xs"></div>
            <button onclick="addBud('apt')" class="w-full text-[10px] border border-dashed rounded py-2 mt-3">+ D√©pense</button>
        </div>
    </div>

    <div id="wish" class="page">
        <h2 class="text-lg font-bold mb-4 ml-2">Wishlist üéÅ</h2>
        <div class="card bg-orange-50">
            <div class="flex gap-2">
                <input type="text" id="w-n" placeholder="Objet" class="input-box bg-white w-2/3">
                <input type="number" id="w-p" placeholder="Prix ‚Ç¨" class="input-box bg-white w-1/3">
            </div>
            <input type="text" id="w-l" placeholder="Lien (URL)" class="input-box bg-white">
            <label class="bg-white w-full py-3 text-center text-xs border border-dashed border-[#C4A484] rounded-xl mb-3 cursor-pointer text-[#C4A484] block">
                üì∏ Photo Galerie
                <input type="file" class="hidden" onchange="compress(this, 'wish')">
            </label>
            <p id="ok-wish" class="text-[10px] text-green-500 text-center hidden mb-2 font-bold">Photo pr√™te !</p>
            <button onclick="addWish()" class="w-full bg-[#C4A484] text-white py-3 rounded-xl font-bold text-xs">Ajouter</button>
        </div>
        <div id="w-grid" class="grid grid-cols-2 gap-3 pb-20"></div>
    </div>

    <div id="deen" class="page">
        <h2 class="text-lg font-bold mb-4 ml-2">Spiritualit√© ü§≤</h2>
        <div class="card"><div id="prayers" class="space-y-1"></div></div>
        <div class="card">
            <p class="text-xs font-bold mb-2">Nos Invocations</p>
            <textarea id="duas" class="w-full h-20 p-2 bg-gray-50 rounded-lg text-sm" placeholder="√âcrire..."></textarea>
            <button onclick="saveDua()" class="w-full mt-2 bg-gray-200 text-gray-600 py-2 rounded-lg text-xs font-bold">Enregistrer</button>
        </div>
        <div class="grid grid-cols-2 gap-3">
            <div class="card text-center"><p class="text-[9px] text-gray-400">VERSETS</p><h3 id="cv" class="text-2xl font-bold my-1 text-[#C4A484]">0</h3><div class="flex justify-center gap-2"><button onclick="upC('v',-1)">-</button><button onclick="upC('v',1)">+</button></div></div>
            <div class="card text-center"><p class="text-[9px] text-gray-400">PAGES</p><h3 id="cp" class="text-2xl font-bold my-1 text-[#C4A484]">0</h3><div class="flex justify-center gap-2"><button onclick="upC('p',-1)">-</button><button onclick="upC('p',1)">+</button></div></div>
        </div>
    </div>

    <nav class="nav-bar">
        <button onclick="nav('home', this)" class="nav-btn active"><i class="fa-solid fa-house"></i></button>
        <button onclick="nav('places', this)" class="nav-btn"><i class="fa-solid fa-map-pin"></i></button>
        <button onclick="nav('chat', this)" class="nav-btn"><i class="fa-solid fa-comments"></i></button>
        <button onclick="nav('budget', this)" class="nav-btn"><i class="fa-solid fa-wallet"></i></button>
        <button onclick="nav('wish', this)" class="nav-btn"><i class="fa-solid fa-gift"></i></button>
        <button onclick="nav('deen', this)" class="nav-btn"><i class="fa-solid fa-moon"></i></button>
    </nav>

    <script>
        // CONFIG FIREBASE (COLLE TES CLES ICI)
        const firebaseConfig = {
            apiKey: "AIzaSyCBZ96lSFIWzPsHklwk3ZU8kfWudfp8oVQ",
            authDomain: "samcy-1136c.firebaseapp.com",
            projectId: "samcy-1136c",
            storageBucket: "samcy-1136c.firebasestorage.app",
            messagingSenderId: "337821844780",
            appId: "1:337821844780:web:4a31a07928e36a1f5a5889"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // USER
        let user = localStorage.getItem('u');
        if(!user) { user = prompt("Samia ou Quincy ?").toLowerCase().trim(); localStorage.setItem('u', user); }
        document.getElementById('u-name').innerText = user;
        function logout() { localStorage.removeItem('u'); location.reload(); }

        // NAVIGATION
        window.nav = (p, btn) => {
            document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
        };

        // --- COMPRESSEUR D'IMAGE (VITAL POUR QUE CA MARCHE) ---
        let imgs = {};
        window.compress = (inp, key) => {
            const file = inp.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 500; // On r√©duit √† 500px max
                    const scale = maxWidth / img.width;
                    canvas.width = maxWidth;
                    canvas.height = img.height * scale;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // Sauvegarde l'image compress√©e
                    imgs[key] = canvas.toDataURL('image/jpeg', 0.7);
                    
                    // Affiche un petit OK
                    if(document.getElementById('ok-'+key)) document.getElementById('ok-'+key).classList.remove('hidden');
                };
            };
        };

        // 1. HOME
        window.setMood=(e, btn)=>{ 
            db.collection('moods').doc(user).set({e}); 
            btn.parentNode.querySelectorAll('button').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
        };
        db.collection('moods').onSnapshot(s=>{ s.forEach(d=>{ if(document.getElementById('m-'+d.id)) document.getElementById('m-'+d.id).innerText=d.data().e; }); });

        const dt=new Date(); const dim=new Date(dt.getFullYear(),dt.getMonth()+1,0).getDate();
        for(let i=1;i<=dim;i++){ document.getElementById('cal-grid').innerHTML+=`<div onclick="selD(${i})" class="aspect-square bg-gray-50 rounded flex items-center justify-center cursor-pointer" id="d-${i}">${i}</div>`; }
        window.selD=(d)=>{ 
            const date=`${dt.getFullYear()}-${dt.getMonth()+1}-${d}`;
            document.getElementById('evt-box').classList.remove('hidden'); 
            document.getElementById('sel-date').innerText=date;
            db.collection('evts').where('d','==',date).onSnapshot(s=>{ 
                document.getElementById('evt-list').innerHTML=''; 
                s.forEach(doc=>document.getElementById('evt-list').innerHTML+=`<div class="flex justify-between border-b pb-1"><span>${doc.data().t}</span><span onclick="del('evts','${doc.id}')" class="text-red-400">x</span></div>`); 
            });
        };
        db.collection('evts').onSnapshot(s=>{ document.querySelectorAll('.bg-[#C4A484]').forEach(e=>e.classList.remove('bg-[#C4A484]','text-white')); s.forEach(d=>{ const day=d.data().d.split('-')[2]; if(document.getElementById('d-'+day)) document.getElementById('d-'+day).classList.add('bg-[#C4A484]','text-white'); }); });
        window.addEvt=()=>{ const t=document.getElementById('new-evt').value; const d=document.getElementById('sel-date').innerText; if(t)db.collection('evts').add({t,d}); document.getElementById('new-evt').value=''; };

        // 2. PLACES
        window.addPlace=()=>{ const n=document.getElementById('pl-name').value; const c=document.getElementById('pl-cat').value; const l=document.getElementById('pl-loc').value; if(n){ db.collection('places').add({n,c,l}); document.getElementById('pl-name').value=''; }};
        db.collection('places').onSnapshot(s=>{ 
            document.getElementById('pl-list').innerHTML='';
            s.forEach(doc=>{ const d=doc.data(); const ic=d.c==='Resto'?'üçù':d.c==='FastFood'?'üçî':'üé¢'; 
            document.getElementById('pl-list').innerHTML+=`<div class="bg-white p-3 rounded-xl shadow-sm border flex justify-between items-center"><div class="flex gap-2 items-center"><span class="text-2xl">${ic}</span><div><p class="font-bold text-sm">${d.n}</p><p class="text-xs text-gray-400">${d.l||''}</p></div></div><button onclick="del('places','${doc.id}')" class="text-gray-300">x</button></div>`; });
        });

        // 3. CHAT (FIXED)
        window.sendMsg=()=>{ const t=document.getElementById('msg').value; if(t){ db.collection('chat').add({type:'txt',t,u:user,time:Date.now()}); document.getElementById('msg').value=''; }};
        window.sendPoll=()=>{ 
            const q=document.getElementById('pq').value; 
            if(q){ 
                db.collection('chat').add({type:'poll',q,i1:imgs.p1,i2:imgs.p2,u:user,time:Date.now()}); 
                document.getElementById('poll-modal').classList.add('hidden'); 
                document.getElementById('pq').value=''; imgs={}; 
            }
        };
        db.collection('chat').orderBy('time').onSnapshot(s=>{ 
            const l=document.getElementById('chat-box'); l.innerHTML=''; 
            s.forEach(doc=>{ const d=doc.data(); const mine=d.u===user; 
                if(d.type==='txt') l.innerHTML+=`<div class="flex flex-col ${mine?'items-end':'items-start'}"><div class="${mine?'bg-[#C4A484] text-white':'bg-white'} px-4 py-2 rounded-2xl text-sm max-w-[80%] shadow-sm mb-1">${d.t}</div></div>`;
                else l.innerHTML+=`<div class="w-full bg-white p-3 rounded-2xl border mb-3 shadow-sm"><p class="font-bold text-xs mb-2 text-[#C4A484]">üìä ${d.q}</p><div class="flex gap-2"><div class="flex-1 h-24 bg-cover rounded-xl border" style="background-image:url('${d.i1}')"></div><div class="flex-1 h-24 bg-cover rounded-xl border" style="background-image:url('${d.i2}')"></div></div></div>`;
            }); 
            l.scrollTop=l.scrollHeight; 
        });

        // 4. BUDGET
        window.editSave=()=>{ 
            const v=prompt("Montant (+ ou -):"); 
            if(v){ 
                const r=prompt("Motif ?");
                const cur=parseInt(document.getElementById('tot-save').innerText); 
                db.collection('stats').doc('s').set({t:cur+parseInt(v)}); 
                db.collection('hist').add({v:v, r:r||'?', d:Date.now()});
            }
        };
        db.collection('stats').doc('s').onSnapshot(d=>{ if(d.exists)document.getElementById('tot-save').innerText=d.data().t+" ‚Ç¨"; });
        db.collection('hist').orderBy('d','desc').onSnapshot(s=>{ 
            document.getElementById('hist-save').innerHTML=''; 
            s.forEach(doc=>{ const d=doc.data(); const c=parseInt(d.v)>0?'text-green-500':'text-red-500'; document.getElementById('hist-save').innerHTML+=`<div class="flex justify-between border-b border-white/10"><span class="w-2/3 truncate">${d.r}</span><span class="${c}">${d.v}‚Ç¨</span></div>`; });
        });

        window.addBud=(c)=>{ const n=prompt("Quoi?"); const p=prompt("Pr√©vu?"); if(n)db.collection('b_'+c).add({n,p,v:0}); };
        function ldBud(c,lid){ db.collection('b_'+c).onSnapshot(s=>{ const l=document.getElementById(lid); l.innerHTML=''; s.forEach(doc=>{ const d=doc.data(); l.innerHTML+=`<div class="grid grid-cols-3 text-xs border-b py-2 items-center"><span>${d.n}</span><span class="text-gray-400">${d.p}‚Ç¨</span><input type="number" value="${d.v}" onchange="upBud('${c}','${doc.id}',this.value)" class="bg-gray-50 w-16 p-1 rounded text-center"><button onclick="del('b_${c}','${doc.id}')" class="text-red-300">x</button></div>`; }); }); }
        window.upBud=(c,id,v)=>db.collection('b_'+c).doc(id).update({v});
        ldBud('wed','l-wed'); ldBud('apt','l-apt');

        // 5. WISHLIST (FIXED WITH COMPRESSOR)
        window.addWish=()=>{ 
            const n=document.getElementById('w-n').value; 
            const p=document.getElementById('w-p').value; 
            const l=document.getElementById('w-l').value; 
            const i=imgs.wish||"https://via.placeholder.com/150"; 
            if(n){ 
                db.collection('wish').add({n,p,l,i,u:user}); 
                document.getElementById('w-n').value=''; 
                document.getElementById('w-p').value=''; 
                imgs.wish=''; 
                if(document.getElementById('ok-wish')) document.getElementById('ok-wish').classList.add('hidden');
            }
        };
        db.collection('wish').onSnapshot(s=>{ 
            const g=document.getElementById('w-grid'); g.innerHTML=''; 
            s.forEach(doc=>{ 
                const d=doc.data(); 
                const badge=d.u==='samia'?'bg-[#C4A484] text-white':'bg-gray-200 text-gray-500';
                g.innerHTML+=`<div class="card p-2 text-center relative overflow-hidden"><div class="h-28 bg-cover bg-center rounded-lg mb-2" style="background-image:url('${d.i}')"></div><p class="font-bold text-xs truncate">${d.n}</p><p class="text-xs font-bold text-[#C4A484]">${d.p?d.p+'‚Ç¨':''}</p><div class="flex justify-between items-center px-1 mt-1"><span class="${badge} text-[9px] px-2 py-0.5 rounded-full font-bold uppercase">${d.u}</span>${d.l?`<a href="${d.l}" target="_blank" class="text-[10px] text-blue-400 underline">Lien</a>`:''}</div><button onclick="del('wish','${doc.id}')" class="absolute top-2 right-2 bg-white rounded-full w-5 h-5 text-red-500 shadow flex items-center justify-center">√ó</button></div>`; 
            }); 
        });

        // 6. DEEN
        const prs=['Fajr','Dhuhr','Asr','Maghrib','Isha']; const today=new Date().toISOString().split('T')[0];
        prs.forEach(p=>{ document.getElementById('prayers').innerHTML+=`<div class="flex justify-between py-1 border-b border-gray-100"><span class="text-sm">${p}</span><input type="checkbox" id="chk-${p}" onchange="chkP('${p}')" class="accent-[#C4A484]"></div>`; });
        window.chkP=(p)=>db.collection('pray').doc(`${today}_${user}`).set({[p]:document.getElementById(`chk-${p}`).checked},{merge:true});
        db.collection('pray').doc(`${today}_${user}`).onSnapshot(d=>{ if(d.exists)prs.forEach(p=>{if(document.getElementById(`chk-${p}`))document.getElementById(`chk-${p}`).checked=d.data()[p]}); });
        window.saveDua=()=>db.collection('deen').doc('d').set({t:document.getElementById('duas').value});
        db.collection('deen').doc('d').onSnapshot(d=>{if(d.exists)document.getElementById('duas').value=d.data().t});
        window.upC=(k,v)=>{ const el=document.getElementById(`c${k}`); const val=parseInt(el.innerText)+v; db.collection('cnt').doc(user).set({[k]:val},{merge:true}); };
        db.collection('cnt').doc(user).onSnapshot(d=>{ if(d.exists){document.getElementById('cv').innerText=d.data().v||0; document.getElementById('cp').innerText=d.data().p||0;} });

        window.del=(c,id)=>{ if(confirm("Supprimer ?")) db.collection(c).doc(id).delete(); };
    </script>
</body>
</html>
