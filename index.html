<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAMCY OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Amiri:wght@400;700&display=swap');
        
        :root {
            --nude-deep: #8E735B;
            --nude-mid: #C4A484;
            --nude-light: #F5EBE0;
            --bg-main: #FAF9F6;
        }

        body { background-color: var(--bg-main); font-family: 'Plus Jakarta Sans', sans-serif; color: #3D352E; overflow: hidden; touch-action: manipulation; }
        
        .page { display: none; height: 100vh; overflow-y: auto; padding: 20px 20px 140px 20px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        .page::-webkit-scrollbar { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* UI ELEMENTS */
        .ios-card { background: white; border-radius: 24px; padding: 20px; box-shadow: 0 4px 15px rgba(142, 115, 91, 0.05); border: 1px solid rgba(142, 115, 91, 0.05); margin-bottom: 15px; }
        .btn-action { background: var(--nude-deep); color: white; border-radius: 12px; padding: 8px 16px; font-size: 12px; font-weight: bold; }
        
        /* TAB BAR */
        .tab-bar { position: fixed; bottom: 30px; left: 24px; right: 24px; height: 70px; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.1); z-index: 100; border: 1px solid rgba(255,255,255,0.5); }
        .nav-item { color: #CCC; font-size: 20px; transition: 0.3s; }
        .nav-item.active { color: var(--nude-deep); transform: scale(1.1); }

        /* CHAT */
        .chat-bubble { padding: 12px 16px; border-radius: 18px; max-width: 80%; font-size: 14px; margin-bottom: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .me { background: var(--nude-mid); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .him { background: white; color: #555; align-self: flex-start; border-bottom-left-radius: 4px; }

        /* CHECKBOXES */
        .prayer-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f7f7f7; }
        .toggle-checkbox { width: 20px; height: 20px; accent-color: var(--nude-deep); }
    </style>
</head>
<body>

    <div id="deen" class="page active">
        <div class="text-center mb-6 pt-6">
            <h2 class="font-['Amiri'] text-2xl text-[var(--nude-deep)]">ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ</h2>
            <p id="date-display" class="text-xs text-gray-400 uppercase tracking-widest mt-1">...</p>
        </div>

        <div class="flex justify-center mb-6">
            <div class="bg-white p-1 rounded-full shadow-sm border flex">
                <button onclick="window.switchUser('samia')" id="btn-samia" class="px-6 py-2 rounded-full text-xs font-bold transition-all bg-[var(--nude-light)] text-[var(--nude-deep)]">SAMIA</button>
                <button onclick="window.switchUser('quincy')" id="btn-quincy" class="px-6 py-2 rounded-full text-xs font-bold transition-all text-gray-400">QUINCY</button>
            </div>
        </div>

        <div class="ios-card">
            <h3 class="text-sm font-bold text-gray-600 mb-4 flex items-center gap-2"><i class="fa-solid fa-mosque"></i> Salat</h3>
            <div id="prayer-list">
                </div>
        </div>
        
        <div class="ios-card">
            <h3 class="text-sm font-bold text-gray-600 mb-4"><i class="fa-solid fa-heart"></i> Extras</h3>
            <div class="prayer-item">
                <span class="text-sm">Lecture Coran</span>
                <input type="checkbox" id="check-quran" class="toggle-checkbox" onchange="window.toggleDeen('quran')">
            </div>
            <div class="prayer-item">
                <span class="text-sm">Duas / Adhkar</span>
                <input type="checkbox" id="check-duas" class="toggle-checkbox" onchange="window.toggleDeen('duas')">
            </div>
        </div>
    </div>

    <div id="home" class="page">
        <h2 class="text-xl font-bold mb-6 pt-6">Tableau de Bord ‚ú®</h2>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="ios-card flex flex-col items-center justify-center py-4" onclick="window.setMood('samia')">
                <span class="text-[10px] font-bold uppercase text-gray-400">Samia</span>
                <span id="mood-samia" class="text-4xl my-2">‚òÅÔ∏è</span>
                <span class="text-[9px] text-gray-300">Modifier</span>
            </div>
            <div class="ios-card flex flex-col items-center justify-center py-4" onclick="window.setMood('quincy')">
                <span class="text-[10px] font-bold uppercase text-gray-400">Quincy</span>
                <span id="mood-quincy" class="text-4xl my-2">‚òï</span>
                <span class="text-[9px] text-gray-300">Modifier</span>
            </div>
        </div>

        <div class="ios-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sm">üìÖ √âv√©nements Cl√©s</h3>
                <button onclick="window.addEvent()" class="btn-action"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="events-list" class="space-y-3">
                <p class="text-xs text-gray-400 text-center py-2">Chargement...</p>
            </div>
        </div>

        <div class="ios-card">
            <div class="flex justify-between items-center mb-2">
                <h3 class="font-bold text-sm">üìù Notes Partag√©es</h3>
                <button onclick="window.saveNote()" class="text-[var(--nude-deep)] text-xs font-bold">Sauvegarder</button>
            </div>
            <textarea id="shared-note" class="w-full bg-gray-50 rounded-xl p-3 text-sm text-gray-600 outline-none h-32 resize-none border border-gray-100" placeholder="√âcrivez vos id√©es ici..."></textarea>
        </div>
    </div>

    <div id="chat" class="page">
        <h2 class="text-xl font-bold mb-4 pt-6">Discussion üíå</h2>
        <div class="flex flex-col h-[75vh]">
            <div id="chat-box" class="flex-1 overflow-y-auto mb-4 flex flex-col pr-1">
                </div>
            <div class="bg-white p-3 rounded-2xl shadow-lg border flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-transparent border-none outline-none text-sm" placeholder="Message...">
                <button onclick="window.sendMessage()" class="w-10 h-10 bg-[var(--nude-deep)] rounded-full text-white"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <nav class="tab-bar">
        <button onclick="window.nav('home', this)" class="nav-item flex flex-col items-center"><i class="fa-solid fa-house"></i></button>
        <button onclick="window.nav('deen', this)" class="nav-item active flex flex-col items-center"><i class="fa-solid fa-kaaba"></i></button>
        <button onclick="window.nav('chat', this)" class="nav-item flex flex-col items-center"><i class="fa-solid fa-comment"></i></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, collection, addDoc, query, orderBy, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- REMPLACE TES CLES ICI ---
        const firebaseConfig = {
            apiKey: "AIzaSyCBZ96lSFIWzPsHklwk3ZU8kfWudfp8oVQ",
            authDomain: "samcy-1136c.firebaseapp.com",
            projectId: "samcy-1136c",
            storageBucket: "samcy-1136c.firebasestorage.app",
            messagingSenderId: "337821844780",
            appId: "1:337821844780:web:4a31a07928e36a1f5a5889"
        };

        // Initialisation
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Variables
        let currentUser = localStorage.getItem('user_role');
        if (!currentUser) {
            currentUser = prompt("Qui es-tu ? (Ecris 'samia' ou 'quincy')").toLowerCase();
            localStorage.setItem('user_role', currentUser);
        }
        
        let viewingUser = currentUser;
        const today = new Date().toISOString().split('T')[0];

        // --- 1. FONCTIONS GLOBALES (IMPORTANT POUR LES BOUTONS) ---
        
        // Navigation
        window.nav = (pageId, btn) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

        // Switch Deen User
        window.switchUser = (user) => {
            viewingUser = user;
            document.getElementById('btn-samia').className = user === 'samia' ? 'px-6 py-2 rounded-full text-xs font-bold transition-all bg-[var(--nude-light)] text-[var(--nude-deep)]' : 'px-6 py-2 rounded-full text-xs font-bold transition-all text-gray-400';
            document.getElementById('btn-quincy').className = user === 'quincy' ? 'px-6 py-2 rounded-full text-xs font-bold transition-all bg-[var(--nude-light)] text-[var(--nude-deep)]' : 'px-6 py-2 rounded-full text-xs font-bold transition-all text-gray-400';
            loadDeen();
        };

        // Deen Logic
        const prayers = ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];
        const listEl = document.getElementById('prayer-list');
        listEl.innerHTML = prayers.map(p => `
            <div class="prayer-item">
                <span class="text-sm font-medium w-20">${p}</span>
                <input type="checkbox" id="check-${p}" class="toggle-checkbox" onchange="window.toggleDeen('${p}')">
            </div>
        `).join('');

        window.toggleDeen = async (id) => {
            if (viewingUser !== currentUser) {
                alert(`Tu ne peux pas cocher pour ${viewingUser} ! (Tricheuse üòâ)`);
                loadDeen(); // Reset visuel
                return;
            }
            const checked = document.getElementById(`check-${id}`).checked;
            try {
                await setDoc(doc(db, "spiritual", `${today}_${currentUser}`), { [id]: checked }, { merge: true });
            } catch (e) {
                alert("Erreur: " + e.message);
            }
        };

        function loadDeen() {
            onSnapshot(doc(db, "spiritual", `${today}_${viewingUser}`), (doc) => {
                const data = doc.exists() ? doc.data() : {};
                prayers.forEach(p => {
                    const el = document.getElementById(`check-${p}`);
                    if(el) el.checked = data[p] || false;
                });
                if(document.getElementById('check-quran')) document.getElementById('check-quran').checked = data['quran'] || false;
                if(document.getElementById('check-duas')) document.getElementById('check-duas').checked = data['duas'] || false;
            });
        }

        // --- 2. HOME LOGIC ---

        // Moods
        window.setMood = async (person) => {
            if(person !== currentUser) return;
            const emojis = ['‚òÅÔ∏è','üòä','‚ù§Ô∏è','ü§≤','üíç','üò¥','üò§','‚ú®'];
            const choice = prompt(`Choisis ton mood:\n${emojis.join(' ')}`);
            if(choice && emojis.includes(choice)) {
                await setDoc(doc(db, "moods", person), { emoji: choice });
            }
        };

        onSnapshot(doc(db, "moods", "samia"), d => { if(d.exists()) document.getElementById('mood-samia').innerText = d.data().emoji });
        onSnapshot(doc(db, "moods", "quincy"), d => { if(d.exists()) document.getElementById('mood-quincy').innerText = d.data().emoji });

        // Notes
        const noteRef = doc(db, "notes", "shared");
        window.saveNote = async () => {
            const txt = document.getElementById('shared-note').value;
            await setDoc(noteRef, { content: txt }, { merge: true });
            alert("Note enregistr√©e !");
        };
        onSnapshot(noteRef, d => { if(d.exists()) document.getElementById('shared-note').value = d.data().content || "" });

        // CALENDRIER (Le fameux bouton +)
        window.addEvent = async () => {
            const title = prompt("Titre de l'√©v√©nement (ex: RDV Mairie) :");
            if(!title) return;
            const date = prompt("Date (ex: 15 Mars) :");
            
            try {
                await addDoc(collection(db, "events"), {
                    title: title,
                    date: date || "Bient√¥t",
                    createdAt: Date.now()
                });
            } catch (e) {
                alert("Erreur ajout √©v√©nement: " + e.message);
            }
        };

        // Afficher les √©v√©nements
        const qEvents = query(collection(db, "events"), orderBy("createdAt", "desc"));
        onSnapshot(qEvents, (snap) => {
            const el = document.getElementById('events-list');
            el.innerHTML = "";
            snap.forEach(doc => {
                const d = doc.data();
                el.innerHTML += `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-xl border border-gray-100">
                        <div>
                            <p class="text-xs font-bold text-gray-800">${d.title}</p>
                            <p class="text-[10px] text-gray-500">${d.date}</p>
                        </div>
                        <button onclick="window.deleteEvent('${doc.id}')" class="text-gray-300 text-xs"><i class="fa-solid fa-trash"></i></button>
                    </div>
                `;
            });
            if(snap.empty) el.innerHTML = '<p class="text-xs text-gray-400 text-center">Aucun √©v√©nement pr√©vu.</p>';
        });

        window.deleteEvent = async (id) => {
            if(confirm("Supprimer cet √©v√©nement ?")) {
                await deleteDoc(doc(db, "events", id));
            }
        }

        // --- 3. CHAT LOGIC ---
        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            
            const chatRef = doc(db, "chat", "main");
            try {
                // On essaie d'ajouter au tableau existant
                await updateDoc(chatRef, {
                    messages: arrayUnion({ text: input.value, sender: currentUser, time: Date.now() })
                });
            } catch (e) {
                // Si le document n'existe pas, on le cr√©e
                await setDoc(chatRef, {
                    messages: [{ text: input.value, sender: currentUser, time: Date.now() }]
                });
            }
            input.value = "";
        };

        onSnapshot(doc(db, "chat", "main"), (doc) => {
            const box = document.getElementById('chat-box');
            if(doc.exists()) {
                const msgs = doc.data().messages || [];
                box.innerHTML = msgs.map(m => `
                    <div class="chat-bubble ${m.sender === currentUser ? 'me' : 'him'}">
                        ${m.text}
                    </div>
                `).join('');
                box.scrollTop = box.scrollHeight;
            }
        });

        // Date du jour
        document.getElementById('date-display').innerText = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
        
        // Load initial Deen
        loadDeen();

    </script>
</body>
</html>
