<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SAMCY OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&family=Amiri:wght@400;700&display=swap');
        
        :root {
            --nude-deep: #8E735B;
            --nude-mid: #C4A484;
            --nude-light: #F5EBE0;
            --sage-green: #9CAF88;
            --bg-main: #FAF9F6;
        }

        body { 
            background-color: var(--bg-main); 
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #3D352E;
            overflow: hidden; /* Emp√™che le scroll √©lastique du navigateur */
        }

        /* --- UI KIT --- */
        .ios-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 24px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(142, 115, 91, 0.04);
            border: 1px solid rgba(142, 115, 91, 0.05);
        }

        .page {
            display: none; height: 100vh; overflow-y: auto;
            padding: 20px 20px 140px 20px; /* Padding bas pour la nav */
            animation: fadeIn 0.4s ease;
        }
        .page.active { display: block; }
        
        /* Masquer la scrollbar */
        .page::-webkit-scrollbar { display: none; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Navigation */
        .tab-bar {
            position: fixed; bottom: 30px; left: 24px; right: 24px;
            height: 70px; background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 35px; border: 1px solid rgba(255,255,255,0.5);
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.05);
            z-index: 50;
        }
        .nav-item { color: #BBB; transition: 0.3s; transform: scale(0.9); }
        .nav-item.active { color: var(--nude-deep); transform: scale(1.1); }

        /* CHECKBOX SPIRITUELLE STYLE IOS */
        .prayer-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid #f0f0f0;
        }
        .prayer-item:last-child { border-bottom: none; }
        
        .toggle-checkbox { display: none; }
        .toggle-label {
            width: 50px; height: 28px; background: #E5E7EB;
            border-radius: 50px; position: relative; cursor: pointer; transition: 0.3s;
        }
        .toggle-label::after {
            content: ''; position: absolute; top: 2px; left: 2px;
            width: 24px; height: 24px; background: white;
            border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: 0.3s;
        }
        .toggle-checkbox:checked + .toggle-label { background: var(--sage-green); }
        .toggle-checkbox:checked + .toggle-label::after { transform: translateX(22px); }

        /* BULLE CHAT */
        .chat-bubble { padding: 10px 16px; border-radius: 18px; max-width: 80%; font-size: 14px; margin-bottom: 8px; }
        .me { background: var(--nude-mid); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .him { background: white; color: #555; align-self: flex-start; border-bottom-left-radius: 4px; border: 1px solid #eee; }

    </style>
</head>
<body>

    <div id="deen" class="page active">
        <div class="text-center mb-6 pt-6">
            <h2 class="font-['Amiri'] text-2xl text-[var(--nude-deep)]">ÿ®ÿ≥ŸÖ ÿßŸÑŸÑŸá ÿßŸÑÿ±ÿ≠ŸÖŸÜ ÿßŸÑÿ±ÿ≠ŸäŸÖ</h2>
            <p class="text-xs text-gray-400 mt-2 uppercase tracking-widest" id="current-date">Aujourd'hui</p>
        </div>

        <div class="flex justify-center mb-6">
            <div class="bg-white p-1 rounded-full shadow-sm border flex">
                <button onclick="switchTracker('samia')" id="btn-samia" class="px-6 py-2 rounded-full text-xs font-bold bg-[var(--nude-light)] text-[var(--nude-deep)] transition-all">SAMIA</button>
                <button onclick="switchTracker('quincy')" id="btn-quincy" class="px-6 py-2 rounded-full text-xs font-bold text-gray-400 transition-all">QUINCY</button>
            </div>
        </div>

        <div class="ios-card mb-4">
            <h3 class="text-sm font-bold text-gray-600 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-mosque text-[var(--sage-green)]"></i> Salat (Pri√®res)
            </h3>
            
            <div id="prayer-list">
                </div>
        </div>

        <div class="ios-card">
            <h3 class="text-sm font-bold text-gray-600 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-book-open text-[var(--sage-green)]"></i> Extras
            </h3>
            <div class="prayer-item">
                <span class="text-sm">Lecture Coran (Wird)</span>
                <input type="checkbox" id="check-quran" class="toggle-checkbox" onchange="toggleDeen('quran')">
                <label for="check-quran" class="toggle-label"></label>
            </div>
            <div class="prayer-item">
                <span class="text-sm">Azkar / Duas</span>
                <input type="checkbox" id="check-duas" class="toggle-checkbox" onchange="toggleDeen('duas')">
                <label for="check-duas" class="toggle-label"></label>
            </div>
        </div>
    </div>

    <div id="home" class="page">
        <h2 class="text-xl font-bold mb-6 pt-4">Notre Espace ‚ú®</h2>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="ios-card flex flex-col items-center justify-center py-6" onclick="setMood('samia')">
                <span class="text-[10px] font-bold uppercase text-gray-400 mb-2">Samia</span>
                <span id="display-mood-samia" class="text-4xl">‚òÅÔ∏è</span>
            </div>
            <div class="ios-card flex flex-col items-center justify-center py-6" onclick="setMood('quincy')">
                <span class="text-[10px] font-bold uppercase text-gray-400 mb-2">Quincy</span>
                <span id="display-mood-quincy" class="text-4xl">‚òï</span>
            </div>
        </div>

        <div class="ios-card mb-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-sm">Calendrier Mariage</h3>
                <button onclick="addEvent()" class="text-[var(--nude-deep)]"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="events-list" class="space-y-3">
                <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-xl">
                    <div class="w-10 h-10 bg-[var(--nude-light)] rounded-full flex items-center justify-center text-[var(--nude-deep)] font-bold text-xs">14</div>
                    <div>
                        <p class="text-xs font-bold">Rencontre Parents</p>
                        <p class="text-[10px] text-gray-400">Mars 2024</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="ios-card">
            <h3 class="font-bold text-sm mb-2">Bloc-Notes üìù</h3>
            <textarea id="shared-note" class="w-full bg-gray-50 rounded-xl p-3 text-sm text-gray-600 outline-none h-24 resize-none" placeholder="Notes partag√©es (strat√©gies, courses, id√©es...)"></textarea>
            <button onclick="saveNote()" class="w-full mt-2 bg-[var(--nude-deep)] text-white py-2 rounded-xl text-xs font-bold">Enregistrer</button>
        </div>
    </div>

    <div id="chat" class="page">
        <h2 class="text-xl font-bold mb-4 pt-4">Messages üíå</h2>
        <div class="flex flex-col h-[calc(100vh-180px)]">
            <div id="chat-container" class="flex-1 overflow-y-auto mb-4 flex flex-col pr-2">
                </div>
            <div class="bg-white p-2 rounded-2xl shadow-lg border flex gap-2">
                <input type="text" id="chat-input" class="flex-1 bg-transparent border-none outline-none text-sm px-2" placeholder="√âcris-lui...">
                <button onclick="sendMessage()" class="w-8 h-8 bg-[var(--nude-deep)] rounded-full text-white flex items-center justify-center"><i class="fa-solid fa-paper-plane text-xs"></i></button>
            </div>
        </div>
    </div>

    <nav class="tab-bar">
        <button onclick="nav('home', this)" class="nav-item flex flex-col items-center">
            <i class="fa-solid fa-house text-xl"></i>
        </button>
        <button onclick="nav('deen', this)" class="nav-item active flex flex-col items-center">
            <i class="fa-solid fa-kaaba text-xl"></i>
        </button>
        <button onclick="nav('chat', this)" class="nav-item flex flex-col items-center">
            <i class="fa-solid fa-comment text-xl"></i>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, arrayUnion, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- TA CONFIGURATION (REMPLACE TES CL√âS ICI) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCBZ96lSFIWzPsHklwk3ZU8kfWudfp8oVQ",
            authDomain: "samcy-1136c.firebaseapp.com",
            projectId: "samcy-1136c",
            storageBucket: "samcy-1136c.firebasestorage.app",
            messagingSenderId: "337821844780",
            appId: "1:337821844780:web:4a31a07928e36a1f5a5889"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- VARIABLES GLOBALES ---
        let currentUser = localStorage.getItem('user_role') || prompt("Es-tu Samia ou Quincy ?").toLowerCase();
        localStorage.setItem('user_role', currentUser); // Sauvegarde pour ne pas redemander
        
        let viewingUser = currentUser; // Qui regarde-t-on dans l'onglet Deen ?
        const today = new Date().toISOString().split('T')[0]; // Date format YYYY-MM-DD

        // --- 1. SYSTEME DE NAVIGATION ---
        window.nav = (pageId, btn) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

        // --- 2. GESTION SPIRITUELLE (DEEN) ---
        
        // Liste des pri√®res
        const prayers = [
            { id: 'fajr', label: 'Fajr', icon: 'fa-cloud-moon' },
            { id: 'dhuhr', label: 'Dhuhr', icon: 'fa-sun' },
            { id: 'asr', label: 'Asr', icon: 'fa-cloud-sun' },
            { id: 'maghrib', label: 'Maghrib', icon: 'fa-sunset' },
            { id: 'isha', label: 'Isha', icon: 'fa-moon' }
        ];

        // G√©n√©rer HTML des pri√®res
        const prayerListEl = document.getElementById('prayer-list');
        prayers.forEach(p => {
            prayerListEl.innerHTML += `
                <div class="prayer-item">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid ${p.icon} text-gray-300 w-6 text-center"></i>
                        <span class="text-sm font-medium">${p.label}</span>
                    </div>
                    <div>
                        <input type="checkbox" id="check-${p.id}" class="toggle-checkbox" onchange="toggleDeen('${p.id}')">
                        <label for="check-${p.id}" class="toggle-label"></label>
                    </div>
                </div>
            `;
        });

        // Fonction pour changer d'utilisateur (Voir Samia ou Quincy)
        window.switchTracker = (user) => {
            viewingUser = user;
            // Update Design Boutons
            document.getElementById('btn-samia').className = user === 'samia' ? 'px-6 py-2 rounded-full text-xs font-bold bg-[var(--nude-light)] text-[var(--nude-deep)] transition-all' : 'px-6 py-2 rounded-full text-xs font-bold text-gray-400 transition-all';
            document.getElementById('btn-quincy').className = user === 'quincy' ? 'px-6 py-2 rounded-full text-xs font-bold bg-[var(--nude-light)] text-[var(--nude-deep)] transition-all' : 'px-6 py-2 rounded-full text-xs font-bold text-gray-400 transition-all';
            
            loadDeenData(); // Recharger les donn√©es
        };

        // Sauvegarder/Cocher une case
        window.toggleDeen = async (itemId) => {
            // On ne peut modifier que SES propres cases
            if (viewingUser !== currentUser) {
                alert("Tu ne peux pas cocher pour " + viewingUser + " ! üëÄ");
                loadDeenData(); // Remet l'√©tat correct
                return;
            }

            const checkbox = document.getElementById(`check-${itemId}`);
            const docRef = doc(db, "spiritual", `${today}_${currentUser}`);
            
            await setDoc(docRef, {
                [itemId]: checkbox.checked
            }, { merge: true });
        };

        // Charger les donn√©es depuis Firebase
        function loadDeenData() {
            const docRef = doc(db, "spiritual", `${today}_${viewingUser}`);
            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Cocher les cases Pri√®res
                    prayers.forEach(p => {
                        const el = document.getElementById(`check-${p.id}`);
                        if(el) el.checked = data[p.id] || false;
                    });
                    // Cocher Extras
                    if(document.getElementById('check-quran')) document.getElementById('check-quran').checked = data['quran'] || false;
                    if(document.getElementById('check-duas')) document.getElementById('check-duas').checked = data['duas'] || false;
                } else {
                    // Si pas de donn√©es pour aujourd'hui (nouveau jour), tout d√©cocher
                    document.querySelectorAll('.toggle-checkbox').forEach(c => c.checked = false);
                }
            });
        }

        // --- 3. MOODS & CHAT & NOTES ---
        
        // Moods
        window.setMood = async (person) => {
            if (person !== currentUser) return; 
            const emojis = ['üòä', '‚òÅÔ∏è', '‚ù§Ô∏è', 'ü§≤', 'üò¥', 'üíç', '‚ú®', 'üò§'];
            const choice = prompt("Choisis ton emoji:\n" + emojis.join(" "));
            if (choice && emojis.includes(choice)) {
                await setDoc(doc(db, "moods", person), { emoji: choice });
            }
        };

        onSnapshot(doc(db, "moods", "samia"), (d) => { if(d.exists()) document.getElementById('display-mood-samia').innerText = d.data().emoji; });
        onSnapshot(doc(db, "moods", "quincy"), (d) => { if(d.exists()) document.getElementById('display-mood-quincy').innerText = d.data().emoji; });

        // Notes Partag√©es
        const noteRef = doc(db, "notes", "shared");
        window.saveNote = async () => {
            const txt = document.getElementById('shared-note').value;
            await setDoc(noteRef, { content: txt }, { merge: true });
            alert("Note sauvegard√©e !");
        };
        onSnapshot(noteRef, (d) => { if(d.exists()) document.getElementById('shared-note').value = d.data().content || ""; });

        // Chat
        const chatContainer = document.getElementById('chat-container');
        window.sendMessage = async () => {
            const input = document.getElementById('chat-input');
            if(!input.value) return;
            const chatRef = doc(db, "chat", "main");
            // On ajoute simplement dans un tableau de messages pour faire simple
            await updateDoc(chatRef, {
                messages: arrayUnion({ text: input.value, sender: currentUser, time: Date.now() })
            }).catch(async () => {
                // Si le document n'existe pas encore
                await setDoc(chatRef, { messages: [{ text: input.value, sender: currentUser, time: Date.now() }] });
            });
            input.value = "";
        };

        onSnapshot(doc(db, "chat", "main"), (doc) => {
            if(doc.exists()) {
                const msgs = doc.data().messages || [];
                chatContainer.innerHTML = msgs.map(m => `
                    <div class="chat-bubble ${m.sender === currentUser ? 'me' : 'him'}">
                        ${m.text}
                    </div>
                `).join('');
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        });

        // INIT
        document.getElementById('current-date').innerText = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });
        loadDeenData(); // Charger les donn√©es initiales

    </script>
</body>
</html>
