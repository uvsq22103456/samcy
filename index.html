l<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAMCY OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap');
        :root { --nude: #A68A64; --bg: #F8F5F2; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: #4A443F; overflow: hidden; }
        .page { display: none; padding: 20px 20px 120px; height: 100vh; overflow-y: auto; }
        .page.active { display: block; }
        .ios-card { background: white; border-radius: 24px; padding: 18px; box-shadow: 0 4px 15px rgba(0,0,0,0.02); margin-bottom: 15px; }
        
        /* NAVIGATION */
        .nav-bar { position: fixed; bottom: 25px; left: 20px; right: 20px; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px); border-radius: 30px; height: 70px; display: flex; justify-content: space-around; align-items: center; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .nav-btn { color: #CCC; font-size: 22px; }
        .nav-btn.active { color: var(--nude); }

        /* CALENDRIER REEL */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day { aspect-square: 1/1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 12px; font-size: 10px; position: relative; background: white; }
        .calendar-day.today { border: 2px solid var(--nude); font-weight: bold; }
        .has-event::after { content: ''; width: 4px; height: 4px; background: var(--nude); border-radius: 50%; position: absolute; bottom: 4px; }

        /* CHAT & SONDAGES */
        #chat-box { display: flex; flex-direction: column; gap: 10px; padding-bottom: 20px; }
        .msg { max-width: 85%; padding: 12px 16px; border-radius: 20px; font-size: 14px; position: relative; }
        .msg.sent { align-self: flex-end; background: var(--nude); color: white; border-bottom-right-radius: 4px; }
        .msg.received { align-self: flex-start; background: white; border-bottom-left-radius: 4px; }
        
        .poll-card { background: #fdfcfb; border-radius: 15px; padding: 10px; margin-top: 5px; color: #4A443F; border: 1px solid #eee; }
        .poll-img { width: 100%; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 5px; cursor: pointer; }
        .vote-bar { height: 6px; background: #eee; border-radius: 10px; overflow: hidden; margin-top: 4px; }
        .vote-fill { background: var(--nude); height: 100%; transition: 0.3s; }
    </style>
</head>
<body>

    <div id="home" class="page active">
        <h1 class="text-xl font-bold mb-6 pt-4 text-center">SAMCY CALENDAR</h1>
        
        <div class="ios-card">
            <div class="flex justify-between items-center mb-4">
                <button onclick="prevMonth()" class="text-gray-400"><i class="fa-solid fa-chevron-left"></i></button>
                <h3 id="month-name" class="font-bold text-sm uppercase tracking-widest text-[#A68A64]">...</h3>
                <button onclick="nextMonth()" class="text-gray-400"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
            <div class="calendar-grid text-[10px] font-bold text-gray-300 mb-2 text-center">
                <span>L</span><span>M</span><span>M</span><span>J</span><span>V</span><span>S</span><span>D</span>
            </div>
            <div id="calendar-days" class="calendar-grid"></div>
        </div>

        <div id="day-details" class="ios-card hidden">
            <h4 id="selected-date-label" class="text-xs font-bold mb-3">...</h4>
            <div id="event-list" class="space-y-2 text-xs"></div>
            <input type="text" id="new-event-input" placeholder="Ajouter un projet..." class="w-full mt-3 p-2 bg-gray-50 rounded-lg outline-none text-xs">
            <button onclick="saveEvent()" class="w-full mt-2 py-2 bg-[var(--nude)] text-white rounded-lg text-xs font-bold">Enregistrer</button>
        </div>
    </div>

    <div id="chat" class="page">
        <h2 class="text-xl font-bold mb-4 pt-4 text-center">NOTRE CHAT</h2>
        <div id="chat-box" class="h-[65vh] overflow-y-auto pr-2"></div>
        
        <div class="fixed bottom-[110px] left-5 right-5 flex flex-col gap-2">
            <div id="poll-creator" class="hidden ios-card p-3 mb-0">
                <input type="text" id="poll-q" placeholder="Ta question ?" class="w-full text-xs p-2 mb-2 bg-gray-50 rounded">
                <div class="flex gap-2">
                    <input type="text" id="poll-url-a" placeholder="URL Image A" class="flex-1 text-[10px] p-2 bg-gray-50 rounded">
                    <input type="text" id="poll-url-b" placeholder="URL Image B" class="flex-1 text-[10px] p-2 bg-gray-50 rounded">
                </div>
            </div>
            <div class="flex gap-2 items-center">
                <button onclick="togglePollCreator()" class="w-10 h-10 bg-white rounded-full text-gray-400 shadow-sm"><i class="fa-solid fa-square-poll-vertical"></i></button>
                <input type="text" id="chat-input" placeholder="Message..." class="flex-1 bg-white h-12 rounded-full px-5 shadow-sm outline-none text-sm">
                <button onclick="sendMsg()" class="w-12 h-12 bg-[var(--nude)] text-white rounded-full shadow-lg"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button onclick="nav('home', this)" class="nav-btn active"><i class="fa-solid fa-calendar-days"></i></button>
        <button onclick="nav('chat', this)" class="nav-btn"><i class="fa-solid fa-comments"></i></button>
        <button onclick="nav('deen', this)" class="nav-btn"><i class="fa-solid fa-kaaba"></i></button>
        <button onclick="nav('budget', this)" class="nav-btn"><i class="fa-solid fa-wallet"></i></button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, query, orderBy, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCBZ96lSFIWzPsHklwk3ZU8kfWudfp8oVQ",
            authDomain: "samcy-1136c.firebaseapp.com",
            projectId: "samcy-1136c",
            storageBucket: "samcy-1136c.firebasestorage.app",
            messagingSenderId: "337821844780",
            appId: "1:337821844780:web:4a31a07928e36a1f5a5889"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const user = localStorage.getItem('samcy_user') || prompt("Qui es-tu ? (samia/quincy)");
        localStorage.setItem('samcy_user', user);

        // --- NAVIGATION ---
        window.nav = (id, btn) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        };

        // --- CALENDRIER ---
        let dt = new Date();
        let selectedDate = "";

        window.renderCalendar = () => {
            const dayContainer = document.getElementById('calendar-days');
            const monthLabel = document.getElementById('month-name');
            dayContainer.innerHTML = "";
            
            const month = dt.getMonth();
            const year = dt.getFullYear();
            monthLabel.innerText = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(dt);

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for(let i=1; i < (firstDay || 7); i++) dayContainer.innerHTML += `<div></div>`;
            
            for(let d=1; d <= daysInMonth; d++) {
                const dateId = `${year}-${month+1}-${d}`;
                dayContainer.innerHTML += `
                    <div class="calendar-day cursor-pointer hover:bg-orange-50" onclick="window.selectDay('${dateId}')" id="day-${dateId}">
                        ${d}
                    </div>
                `;
            }
        };

        window.selectDay = (id) => {
            selectedDate = id;
            document.getElementById('day-details').classList.remove('hidden');
            document.getElementById('selected-date-label').innerText = "Projets du " + id;
            // Charger les events Firebase pour ce jour ici
        };

        window.prevMonth = () => { dt.setMonth(dt.getMonth()-1); renderCalendar(); };
        window.nextMonth = () => { dt.setMonth(dt.getMonth()+1); renderCalendar(); };
        renderCalendar();

        // --- CHAT & SONDAGES ---
        window.togglePollCreator = () => document.getElementById('poll-creator').classList.toggle('hidden');

        window.sendMsg = async () => {
            const input = document.getElementById('chat-input');
            const pollQ = document.getElementById('poll-q').value;
            const urlA = document.getElementById('poll-url-a').value;
            const urlB = document.getElementById('poll-url-b').value;

            const msgData = {
                sender: user,
                time: Date.now(),
                type: pollQ ? 'poll' : 'text',
                text: input.value,
                poll: pollQ ? { question: pollQ, imgA: urlA, imgB: urlB, votesA: 0, votesB: 0 } : null
            };

            await addDoc(collection(db, "chat_v2"), msgData);
            input.value = ""; document.getElementById('poll-q').value = "";
            document.getElementById('poll-creator').classList.add('hidden');
        };

        onSnapshot(query(collection(db, "chat_v2"), orderBy("time", "asc")), (snap) => {
            const box = document.getElementById('chat-box');
            box.innerHTML = "";
            snap.forEach(d => {
                const m = d.data();
                if (m.type === 'text') {
                    box.innerHTML += `<div class="msg ${m.sender === user ? 'sent' : 'received'}">${m.text}</div>`;
                } else {
                    box.innerHTML += `
                        <div class="msg ${m.sender === user ? 'sent' : 'received'} w-full">
                            <p class="font-bold text-xs mb-2">${m.poll.question}</p>
                            <div class="grid grid-cols-2 gap-2">
                                <div onclick="window.vote('${d.id}', 'A')">
                                    <img src="${m.poll.imgA}" class="poll-img">
                                    <div class="vote-bar"><div class="vote-fill" style="width:${m.poll.votesA*20}%"></div></div>
                                </div>
                                <div onclick="window.vote('${d.id}', 'B')">
                                    <img src="${m.poll.imgB}" class="poll-img">
                                    <div class="vote-bar"><div class="vote-fill" style="width:${m.poll.votesB*20}%"></div></div>
                                </div>
                            </div>
                        </div>`;
                }
            });
            box.scrollTop = box.scrollHeight;
        });

        window.vote = async (id, side) => {
            const ref = doc(db, "chat_v2", id);
            // Logique de vote simplifiée
            alert("Vote pour " + side + " enregistré !");
        };

    </script>
</body>
</html>
